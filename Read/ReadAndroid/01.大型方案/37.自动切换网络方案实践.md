#### 目录介绍
- 01.整体概述介绍
    - 1.1 项目背景
    - 1.2 核心思路说明
    - 1.3 设计目标
    - 1.4 收益分析
    - 1.5 项目风险点
- 02.方案设计思路
    - 2.1 需求拆解分析
    - 2.2 总体设计重点
    - 2.3 如何设置优先级
    - 2.4 网络判断策略
    - 2.5 网络切换策略
    - 2.6 Wi-Fi切换&连接
    - 2.7 多Wi-Fi连接
- 03.方案设计图
    - 3.1 整体架构图
    - 3.2 UML设计图
    - 3.3 关键流程图
    - 3.4 模块依赖关系
- 04.原理解读研究
    - 4.1 网络管理机制
    - 4.2 Wi-Fi间切换
    - 4.3
- 05.遇到的问题
    - 5.1 打开Wi-Fi失败




### 01.整体概述介绍
#### 1.1 项目背景
- 业务背景介绍
    - 1、优先级：网线>Wi-Fi>移动流量(机具可能有网卡) ；2、网线不通情况下自动切换到回无线网；3、无线网也只有3分钟不通的情况才自动切换回网线。
- 网络类型说明
    - 1.Wi-Fi网络；2.网线；3.移动流量(5G/4G/3G等)；4.无网络。目前大体分为这四种
    - 2.Wi-Fi网络分成不同场景：A.连接Wi-Fi可用；B.连接Wi-Fi不可用；C.未连接不可用
    - 3.网线分成不同场景：A.连接网线可用；B.连接网线不可用；C.未连接不可用
    - 4.移动流量分成不同场景：A.连接移动流量可用；B.连接移动流量不可用；C.未连接不可用
- 网络组合的场景
    - 按照每一种网络类型有3种场景，那么组合到一起，则一共有27种不同业务场景。
    - 场景太多，显然不能单纯地配对实现(这种场景太多导致复杂化)，应该按照某种特定的优先级去切换网络。



#### 1.2 核心思路说明
- 按照优先级去切换网络
    - 举一个例子：网络连接优先级是网线>Wi-Fi>移动流量，那么在开发阶段种就按照这种情况去检测网络，按优先级连接切换，否则场景多了搞的好复杂！
- 检测网络的轮询操作，总结以下3种场景
    - 如果网线可用，其他两种不论是否可用。这个时候都是用网线，3分钟检测逻辑不做业务处理。
    - 如果网线不可用，其他两种有一种可用。这个时候就先用Wi-Fi(移动流量)，3分钟轮询检测网线是否可用，如果检测可用，则切换到网线
    - 如果网线不可用，其他两种也不可用。这个时候就3分钟心跳，按网络连接优先级检测网络，如可用则连接优先级最高的网络！
- 按照优先级去切换网络
    - 场景1: 网线与无线同时正常。那这个时候按照优先级，优先使用网线！
    - 场景2: 网线网络正常，无线不通。那这个时候按照优先级，优先使用网线！
    - 场景3: 网线网络不通，无线网正常。那这个时候按照优先级，优先使用无线网！
    - 场景4: 网线、无线网都不通。那这个时候按照优先级，优先使用无线网！次之Wi-Fi



#### 1.3 设计目标
- 设计成独立功能库
    - 做成maven功能库，暴露外部api接口
- 可以配置策略
    - 网线-4G-Wi-Fi不通环境切换，可以配置切换环境后时间配置。还可以网络连接优先级策略


#### 1.4 收益分析
- 提升产品体验
    - 网络不稳定的时候，之前需要用户手动去切换环境，由于是设备(有些设备是按键操作)不太好操作网络切换，因此体验上缺少友好感。
    - 增加网络监听，并自动按照优先级策略，切换网络环境。可以强化产品体验。


#### 1.5 项目风险点


### 02.方案设计思路
#### 2.1 需求拆解分析
- 分析1: 如何设置wifi、以太网优先级？
- 分析2: 用户设置优先级后，如何实现网络切换？
- 分析3: Wi-Fi有多个，怎么去连接Wi-Fi。Wi-Fi连接失败，密码错误怎么处理？
- 分析4: 拔下网线，如果监听以太网不可用，然后网络切换？



#### 2.2 总体设计重点
- 业务分析思路
    - A.优先选择网线的模式，如果网线连接并且有数据流量，则优先使用网线
    - B.如果网线不通情况(网线未连接/网线网络断开等)，则自动切换到Wi-Fi无线网
    - C.切换到无线网，搜索无线网有多个，优先切换到上一次连接无线网(无线网需要密码)
    - D.如果无线网切换成功，则开启无线网模式
    - E.如果无线网3分钟不通情况下，则自动切换到网线模式
- 网络为何要自动切换
    - 网线和WIFI都连接的时候，Android默认使用网线，但有时候网线松动或者不可用了，这个时候需要自动切换到Wi-Fi环境。
    - Wi-Fi连接的时候也可能会遇到一些问题，比如现实环境中不可能到处都有wifi，或者Wi-Fi不可用，所以Android设备会经常自动切换网络。
- 突破口：网络监听
    - 监听网线连接是否可用，两种情况，第一种网线没插上，第二种网上插上但网络不可用；
    - 监听Wi-Fi是否可用，判断Wi-Fi是否连接上并且有数据流量。Wi-Fi可能有多个，从A切换到B的Wi-Fi策略要思考下；
    - 关于切换网络环境后，比如从网线切换到Wi-Fi，如果3分钟不通那么又要切回网线，这个也需要监听



#### 2.3 如何设置优先级
- 如何设置网络优先级
    - A.使用Settings.global设置用户优先级，供ConnectivityService使用
    - B.使用ConnectivityManager.setNetworkPreference
- 在Android9.0设置有线网络优先级直接修改EthernetNetworkFactory.java的 NETWORK_SCORE 值就行
    - 研究了一下EthernetNetworkFactory.java和ConnectivityService.java发现里面的逻辑有很大的修改。
- 在Android11 修改有线网络优先级。找到EthernetNetworkFactory.java的getNetworkScore()方法，这里面返回的score才是有线网的有效分值；
    - 这个getNetworkScore()方法是在Android11 新增的。在该方法返回NETWORK_SCORE值即可。



#### 2.4 网络判断策略



#### 2.5 网络切换策略
- 以太网判断逻辑
    - 不管是拔掉网线，或者网线松动，或者网线连接正常但是是断开场景，或者网线连接正常但数据传输失败。都可以认为以太网不可用。
- 如何判断以太网不可用？如何监听以太网不可用？
    - 待完善
- 设置优先级后，连接上对应优先级网络。策略的实现思路
    - 1.利用评分机制，默认以太网具有最高优先级分数70，wifi优先级分数为60。当需要wifi优先时，将以太网优先级分数调整为30。由于wifi和以太网无法共存，只能有一个在线，须init.rc中设置路由表（ip ru add from all lookup main pref 9000）后实现共存。
    - 2.ConnectivityService.java中，解决一个网络上线后另外一个网络被踢掉问题。
- 注意点说明：
    - 考虑最大程度整合原生系统的评分机制，通过Setting.Global获取到优先级参数后，只对用户设置的优先级进行特殊处理，其他情况采用系统方案。
    - 因为毕竟系统中还有wifi，以太网、Mobile等网络，破坏了原有评分系统，会导致很多side effects。



#### 2.6 Wi-Fi切换&连接
- 项目中有通过已知WiFi名称和密码连接硬件设备WiFi，实现数据交换的需求。
    - 给定WiFi名称，连接无密码的网络
    - 给定WiFi名称 和密码，连接网络 （需指定密码类型 wpa 或者web ）
- 连接Wi-Fi的大概步骤
    - 第一步：打开、关闭WIFI。WiFi的打开和关闭用的 WifiManager 类中的setWifiEnabled方法实现。
    - 第二步：WiFi连接。输入WiFi名称、密码实现连接。
    - 第三步：断开WIFI连接。断开WiFi连接有两种方法：暂时断开，可以重连；断开，不可以重连，忘记密码。




### 03.方案设计图
#### 3.1 整体架构图


#### 3.2 UML设计图


#### 3.3 关键流程图


#### 3.4 模块依赖关系



### 04.原理解读研究
#### 4.1 网络管理机制
- Android6.0之后系统中优先级设置都是根据Score分值来设置优先级，分值0-100，数值越高，越优先。
    - 系统默认分值：SIM卡网络50；wifi网络60；有线网络70
    - 具体代码：NetworkAgentInfo#getCurrentScore
- NetworkFactory的子类都有NETWORK_SCORE常量，表示该网络的分值。
    - 手机网络设置都有自己的Factory设置类，都继承自NetworkFactory.java
    - wifi网络设置类：WifiNetworkFactory.java
    - 有线网络设置类：EthernetNetworkFactory.java



### 05.遇到的问题
#### 5.1 打开Wi-Fi失败
- 对启用和停用 WLAN 实施了限制
    - Android 10 或更高版本为目标平台的应用无法启用或停用 WLAN。WifiManager.setWifiEnabled() 方法始终返回 false。
- 解决办法如下
    - 如果您需要提示用户启用或停用 WLAN，请使用设置面板。对直接访问已配置的 WLAN 网络实施了限制


#### 5.2 开启Wi-Fi有延迟
- 开启WiFi一般需要一定的时间,因此不能立马去连接，需要等WiFi稳定可用，经测试一般2.5秒即可完成。因此建议延迟一下！



# 1
- Android6.0通过WiFi名称密码连接WiFi的方案 转载
  - https://blog.51cto.com/u_15858333/5817472
- Android网络切换分析
  - https://blog.csdn.net/u011006622/article/details/79413115
- 安卓(Android)网络管理工具
  - https://www.cnblogs.com/muphy/p/15620772.html
- 一种WiFi连接失败原因检测方法及系统
  - https://patents.google.com/patent/CN105119776A/zh
- Android/Linux检测网线是否插入
  - https://codeantenna.com/a/j85m3dNgnL
- 以太网适配器
  - https://github.com/kopihao/android-ethernet-adapter
- 网络优先级简单刨析参考：
Framework中的连接管理机制： https://blog.csdn.net/u010961631/article/details/48629601
网络连接评分机制之NetworkFactory： https://blog.csdn.net/u010961631/article/details/48971431
网络连接评分机制之NetworkAgent： https://blog.csdn.net/u010961631/article/details/48971651
Android网络优先级及更改： https://blog.csdn.net/u013686019/article/details/51447129/
网上的代码都比较旧了，只能做思路参考，里面有些方法不一样了。