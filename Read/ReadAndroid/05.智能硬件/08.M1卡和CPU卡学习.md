#### 目录介绍
- 01.整体概述
    - 1.1 项目背景说明
    - 1.2 IC智能卡说明
    - 1.3 基础概念介绍
- 02.CPU卡基础学习
    - 2.1 CPU基础概念
    - 2.2 CPU操作流程
    - 2.3 读卡器与卡交互指令
    - 2.4 APDU指令学习
- 03.M1卡基础学习




#### 1.1 项目背景说明
- IC卡使用场景说明
    - 总所周知，IC卡（智能卡）在身份验证、公共交通、门禁系统、银行、保险等领域随处可见。
- IC卡基本概念和相关知识
    - IC卡 (Integrated Circuit Card，集成电路卡)，也称智能卡(Smart card)、智慧卡(Intelligent card)、微电路卡(Microcircuit card)或微芯片卡等。
    - IC卡与读写器之间的通讯方式可以是接触式，也可以是非接触式。



#### 1.2 IC智能卡说明
- IC卡种类
    - 按功能分为复合卡（可刷、又可插、还能碰触）和普通卡（碰触，如二代身份证）
    - 按卡片协议类型：卡片类型ISO 14443 A类和B类、ISO 7816 A、B和C类等
    - 按智能卡接口：PICC （非接触）、ICC（接触）、SAM
- 日常生活常见的ID卡
    - 公交卡、社保卡、CPU卡、M1卡、、SAM卡、PSAM卡等等都属于IC卡。
- 二代身份证属于IC卡
    - 还有我们的二代身份证属于CPU卡或ID 卡，确切来说属于非接触式CPU卡(采用的标准ISO 14443 TYPE B协议)，里面的芯片采用的加密算法是国密（SM1），芯片的提供商有大唐微电子、华虹、华大和同方微电子等厂商。



#### 1.3 基础概念介绍
- IC卡读写过程数据传输协议
    - 在传输协议中定义了两种协议：字符传输协议（T=0）和块传输协议（T=1）。IC卡可以选择支持T=0协议或者T=1协议，终端一般都支持这两种协议。
    - 在ATR中的TD1规定了后续传输中所采用的传输协议（T=0或T=1），如果TD1在ATR中不存在的话则假定采用T=0。
- 什么叫做ATR
    - ATR也叫复位应答，是一个字节序列，这些字节是由卡作为对复位命令的响应发送给读卡器的。
    - 在I/O电路上，每个成功的复位操作都会导致I/O上的一个由初始字符TS开始，后跟最多32个字符的复位应答。
    - ATR的作用是告诉读卡器，我是一张什么样的卡片，以便读卡器知道接下来该以什么样的方式和卡片通信。



### 02.CPU卡基础学习
#### 2.1 CPU基础概念
- 进行APDU通讯的前提是：
    - 有读卡器（必选）和对应的SDK通讯包（可选）
    - 知道IC卡的APDU命令
- **APDU是智能卡与智能卡读卡器之间传送的信息单元**

    |  CLA   | INS | P1 | P2  | Lc | Data| Le |
    | :----  | :---- | :----  | :----  | :----  | :----  | :----  |
    | 指令类别 | 指令码 | 参数P1 | 参数P1 | Data的长度（不超过255个字节）  | 返回数据  | 表示响应时回答的数据字节数，0表是需要最大可能长度（不超过255个字节） |
- APDU命令格式分类(报文结构，从终端设备发出的命令和卡片信息必须按照四种格式发送)
    - ① 情形1：CLA INS P1 P2 00
    - ② 情形2：CLA INS P1 P2 Le
    - ③ 情形3：CLA INS P1 P2 Lc Data
    - ④ 情形4：CLA INS P1 P2 Lc Data Le
- APDU响应报文(响应数据 响应状态码)
    - Data SW1 SW2 如何理解？DATA：返回给用户的数据，即命令的执行结果。SW1、SW2： 返回命令处理的状态。
    - 响应也对应几种情形 ① 情形1：SW1 SW2；② 情形2：Le字节的Data SW1 SW2
    - 关于响应报文的错误码，具体可以看：https://blog.csdn.net/lonet/article/details/7541265




#### 2.2 CPU操作流程
- 如何去操作CPU卡
    - 手机去感应非接触式CPU卡一般都是通过NFC，想用手机去感应身份证有两个前提：一你手机支持NFC功能，二你得知道对操作身份证的指令。
    - 比如读取身份的指令，知道指令后你就可以开发个手机app然后进行感应读取身份。
- 读卡器APDU流程，接触过的读卡器基本都下面这些步骤，基本相同，不同的是命令发送和数据解析
    - ICC（接触读取）：1.打开阅读器；2.对卡片上电；3.获取ATR(接触卡状态检测，是否存在卡片)和协议；4.APDU通讯；5.下电；6.关闭阅读器
    - PICC（非接触读取）：1.打开阅读器；2.寻找卡片；3.APDU通讯；4.关闭阅读器



#### 2.3 读卡器与卡交互指令
- 1.读卡器与卡交互第一步一般是选择应用。
    - 一张IC卡里面可能有多个应用，所谓应用就是卡片和终端之间的应用协议和相关的数据集，读卡器和卡的交互其实就是和应用的交互，卡的交易其实就是选择某个应用做交易。
    - 目前卡商所生产的卡基本上都是一个应用，即便如此，但根据银联卡的规范，应用选择这个步骤也是必不可少的。
- 2.第二步根据上面的返回数据做下一步操作，并最终拿到结果
    - 如果是一般卡(非银联卡)，响应数据就是想要的数据是直接数据，进行转码就可以达到想要的数据。




#### 2.4 APDU指令学习
##### 2.4.1 APDU是什么
- APDU即应用协议数据单元
    - 是智能卡与读卡器之间通信的标准方式，定义了智能卡和终端的通信规范。
    - 举一个案例，比如发送1条APDU指令，发送数据：00A4040006A00000000101，那么这串数据有什么规范呢？
- APDU应用场景介绍
    - APDU提供了一种标准的、协议无关的方法，用于智能卡和终端设备进行通信。它是智能卡系统的核心组件，广泛应用于银行卡、身份证、健康卡等各种应用场景。



##### 2.4.2 APDU指令组成
- APDU指令由四个部分组成：
    - CLA（Class）：指令类别，用于确定指令所属的指令集，如00表示标准指令集，80表示安全指令集。
    - INS（Instruction）：指令代码，用于区分执行的操作，如06表示比较指令，0A表示读二进制文件指令。
    - P1（Parameter 1）和P2（Parameter 2）：用于提供有关指令的附加信息，如P1-P2可以指定要读取或写入的数据块的位置、长度、偏移量等。
    - Lc（Length of command data）：用于指定指令的数据长度。
    - Data：用于传输指令数据，如读取或写入指定的内存块或文件。
- APDU响应部分包括两个部分：
    - 响应数据的数据长度（Le）：用于指定响应数据的长度，可以在命令中指定也可以由智能卡决定。
    - 响应数据的实际内容：用于传输操作结果。
- APDU在智能卡和读卡器之间进行通信
    - 包含两个部分：C-APDU（指令）和R-APDU（响应）。C-APDU被发送给智能卡，智能卡处理以后返回一个R-APDU进行响应。



##### 2.4.3 发送指令详细剖析
- 例子：/send 00A4040006A00000000101
    - 这条指令是一个APDU指令，用于选择与AID（Application Identifier，应用标识符）相对应的应用程序。
- 具体来说，它的结构如下：
    - CLA（Class）：0x00 表示标准指令集
    - INS（Instruction）：0xA4 表示选择文件命令
    - P1（Parameter 1）：0x04 表示选择应用程序的命令模式
    - P2（Parameter 2）：0x00 表示选择应用程序的第一组（或唯一一组）文件，这是应用程序的根文件
    - Lc（Length of command data）：0x06 表示接下来有6个字节的数据
    - Data：A00000000101 表示应用标识符（AID），它是一个16进制数字串，用于确定要选择的应用程序
- 以此为例
    - 发送该APDU指令可以将具有AID为A00000000101的应用程序选择为活动应用程序，并通过通道来与其通信


##### 2.4.4 响应指令解析
- 例子：第一个响应指令，9FE7398E9000；第二个响应指令，9000
- 先来看第一个指令：9FE7398E9000
    - 属于Le字节的Data SW1 SW2状态，那么它是什么含义？Le表示响应data，SW1表示命令处理状态；SW2表示命令处理限定。
    - 那么9FE7398E9000拆分，即可Le是9FE7398E，SW1是90，SW2为00，整体意义解读执行成功。
- 再来看第二个指令：9000
    - 属于SW1 SW2状态，那么它是什么意义？SW1表示命令处理状态；SW2表示命令处理限定。
    - 那么9000拆分，即可SW1是90，SW2为00，整体意义解读是正确执行。






