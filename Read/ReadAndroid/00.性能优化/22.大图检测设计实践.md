#### 目录介绍
- 01.背景说明
    - 1.1 项目背景
    - 1.2 需求分析
    - 1.3 衡量标准
    - 1.4 建设目标
    - 1.5 项目收益
- 02.一些基础概念
- 03.实现思路步骤
    - 3.1 总体实现思路
    - 3.2 技术实现选型
- 04.关键技术要点
- 05.方案基础设计
    - 5.1 整体架构图
    - 5.2 UML设计图
    - 5.3 关键流程图
    - 5.4 接口设计图
    - 5.5 模块间依赖关系
- 06.其他设计说明
    - 6.1 性能设计
    - 6.2 稳定性设计
    - 6.3 灰度设计
    - 6.4 降级设计
    - 6.5 异常设计
    - 6.6 兼容性设计
    - 6.7 自测case设计


### 01.背景说明
#### 1.1 项目背景
- 大图监控的功能，可以对图片的文件大小和所占用的内存大小设置一个阈值，当图片超过该值的时候进行提示。
- 虽然现在大家都使用Glide等三方 图片加载框架，框架会自动对图片进行压缩，但是依然会出现压缩后所占内存超过预期的情况。
- 这时候我们可以在开发、测试和预生产阶段使用大图监控来识别出那些超标的图片。


#### 1.2 需求分析
- 在讨论如何做之前，必须明确我们要做什么。该大图监控框架我觉得应该实现以下功能：
    - 能对图片的文件大小和所占用的内存大小设置阈值，超过其中之一则报警。
    - 能够得到超标图片的详细信息，包括当前文件大小，所占用内存，图片分辨率，图片的略缩图，图片的加载地址，view的尺寸。
    - 能够通过弹窗或者列表的方式查看当前超标的图片信息。
    - 不论是本地加载图片还是网络加载图片都能够进行监控。


#### 1.3 衡量标准


#### 1.4 建设目标


#### 1.5 项目收益


### 03.实现思路步骤
#### 3.1 总体实现思路
- 要实现对图片文件大小和所占内存的监控，那么我们就得先知道图片的文件大小和加载该图片所耗费的内存。
- 目前加载图片一般都使用第三方框架，所以可以对常用的图片加载框架进行Hook,这里主要对主流的四种图片加载框架进行Hook操作。
    - Glide；Picasso；Fresco；Image Loader
- 从网络加载一张图片举例
    - 当使用图片框架加载一张网络图片时，会使用OkHttp或者是HttpUrlconnection去下载该图片,这时候我们就能得到图片文件的大小。
    - 当图片框架将图片文件构造成Bitmap对象以后，又能得到其所占用的内存，这样就同时的得到了图片的文件大小和所占用的内存。那么这里必须对OkHttp和HttpUrlconnection进行Hook。


#### 3.2 技术实现选型
- 既然要对三方框架进行Hook操作，那么我们如何进行Hook呢？在选择Hook的实现方案时，对以下几种方案进行了调研。
    - 反射+动态代理
    - ASM
    - AspectJ
    - ByteBuddy
- 首先反射+动态代理 只能在程序运行时进行，这样会影响效率，所以暂不考虑。其他三种方案都能够在编译期进行字节码插桩，ASM直接操纵字节码，阅读起来不那么友好。
- AspectJ以前用过，经常出一些莫名其妙的问题，体验不是很好。ByteBuddy 封装了ASM，据说效率很高，而且使用JAVA编写，代码可读性好，只是网上的资料太少了。
- 所以这里最后选择了ASM实现。






### 大图检测
- https://mp.weixin.qq.com/s/i0MOwQP9VfOyluQtWuFfMg
- https://juejin.cn/post/7011276367308750879
- https://blog.csdn.net/qq_42795723/article/details/107822387


