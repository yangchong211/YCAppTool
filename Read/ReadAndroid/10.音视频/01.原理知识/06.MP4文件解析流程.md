# MP4文件解析流程
#### 目录介绍
- 01.视频播放背景说明
- 02.Mp4格式文件的构成
- 03.标准播放器启动流程


### 01.视频播放背景说明
- 以最常见的MP4文件入手。
    - 然后会简短的介绍一个标准的播放器的启动，解析，播放流程。比如Exoplayer，谷歌的分包策略就是根据播放器的组件来分包。
- 理解好每个基础概念。Mp4格式文件的构成；Mp4头文件的构成；标准播放器的启动流程；在线视频播放的技术基础(online video streaming)



### 02.Mp4格式文件的构成
- 通俗的说，MP4其实是一种格式的规范
    - 这个规范是被ISO机构认证的，也就是说，只要你通过Codec生成了一个mp4文件，那么这个文件的格式必须是按照ISO机构的规矩来。[ISO的MP4文件规范](https://xhelmboyx.tripod.com/formats/mp4-layout.txt)
- 视频都是结构化容器文件
    - 任何容器，包括mp4都是类似的结构化文件，只不过不同的格式文件ISO对其有严格的要求，数据的摆放顺序，排列等等不同而已。
    - 有兴趣的同学可以对比一下rmvb，mp4，mkv，avi这些格式的要求有什么不同，优劣势各是什么。


### 03.标准播放器启动流程
- 那么既然我们已经知道一个容器文件的格式规范了，播放器就可以通过解析容器的头文件来控制播放(playback)了。


#### 3.1 播放器
- 通常播放器由三个部分构成
    - 读取器(Extractor)
    - 渲染器(TrackRenderer)
    - 加载控制器(Load Controller)
    - 数据源(Source)
- 读取器负责从source文件读取数据，加载控制器负责控制读取数据的策略(比如说在线视频播放的时候缓冲策略)，渲染器负责接收读取器读取的数据，并渲染到屏幕上。


#### 3.2 播放器播放过程
- 在播放器可以把数据提交给渲染器之前，播放器需要把必需的头文件全部解析并存入内存，比如之前说的采样索引表。
    - 一般播放器在解析完毕后，会构建三个个表，一个存放时间对应采样索引，一个存放采样索引对应在mp4文件中的起始位置(以字节为单位),一个存放采样索引对应大小(以字节为单位)。
- 假设播放器需要从第1微秒开始播放，那么需要把第1微秒的数据放入渲染器。所以会查找下面这三个表。
    - ![image](https://github.com/richardissuperman/videoconcepts/blob/master/images2/Screen%20Shot%202017-04-21%20at%204.57.38%20pm.png?raw=true)
    - 通过表1，我们知道该微秒对应第1个采样（sample），从第一个和第二个表我们知道，第1个采样的数据范围(在mp4文件内)是从第0字节到300（0+300）字节，那么播放器就会去读取这个范围的数据并且放入渲染器中进行渲染。
    - 同时，加载器会基于当前已经缓存的数据，决定是否还需要不停的读取数据进入内存。一般来说每个播放器都有默认的缓存值，也会有一个基准线，只有当缓存足够数据才能放进渲染器进行渲染。
    - 最后同理，当我们拖动滑动控制器(SeekBar)想快进的时候，我们和第一步一样，通过我们想滑动的时间获取采样的索引，再重新开始读取数据。
























