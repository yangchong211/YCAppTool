# 视频边播边缓存分析
#### 目录介绍
- 01.整体概述
    - 1.1 项目背景
    - 1.2 遇到问题
    - 1.3 基础概念介绍
    - 1.4 设计目标
    - 1.5 产生收益分析
- 02.方案调研与分析
    - 2.1 实践方案有哪些
    - 2.2 文件整体缓存
    - 2.3 修改源码缓存
    - 2.4 缓存代理方案
- 03.设计方案演进
    - 3.1 考量常见缓存策略
    - 3.2 
- 04.致敬优秀开源项目
    - 4.1 项目简单介绍
    - 4.2 项目如何使用
    - 4.3 项目缓存原理
    - 4.4 整体设计思路
- 03.原理流程分析
    - 3.1 一些核心类分析
- 03.如何实现预加载




### 01.整体概述
#### 1.1 项目背景
- 三方播放器都自带完善的缓存功能
    - 但对于内容和形式都日新月异的一众互联网产品来说，想要打造完美契合自家产品的用户体验，播放器自身的缓存机制已逐渐无法满足需求。
- 渴望视频上下切换能无缝切换
    -  在播放短视频内容时，保证浏览、上下切换时 无缝链接 般丝滑的用户体验，可以说是重中之重的性能要求。因此要做边播边缓存的功能！



#### 1.2 遇到问题
- 边播边缓存
    - 一些知名的视频app客户端（优酷，爱奇艺）播放视频的时候都有一些缓存进度(二级进度缓存)，微信有关的小视频，还有一些短视频app，都有边播边缓的处理。
    - 还有就是当文件缓存完毕了再次播放的话就不再请求网络了直接播放本地文件了。既节省了流程又提高了加载速度。



#### 1.3 基础概念介绍



#### 1.4 设计目标



#### 1.5 产生收益分析


### 02.方案调研与分析
#### 2.1 实践方案有哪些



#### 2.2 文件整体缓存
- 最简单的缓存方案
    - 先下再播 ，只有文件完整下载完毕，才能进行播放。在某些特殊的业务场景，这种方案简单、粗暴但却 有效。
- 举一些实际的场景
    - 比如微信聊天中的小视频，经过限制时长以及高效的压缩算法，视频整体被压缩的非常小，对于 4G 早已覆盖的用户群体而言，加载、播放视频整个流程中几乎不受影响。
- 有些场景该方案不合适
    - 诸如短视频、播放音乐，这种方案就不太适合，更不论电视剧、电影这类更重的应用场景了。


#### 2.3 修改源码缓存
- 基于播放器源码进行修改
    - 优势在于简洁直接，能够以较低开发成本满足业务需求，要求要搞透彻源码原理。对开发有一定高度要求！
- 缺点也比较明显
    - 当播放器为三方SDK时，源码修改成本变高，同时，当需要替换播放器SDK时，需针对缓存机制重新开发。
    - 其次，缓存机制不可避免会涉及实际业务，这会提升业务层与底层播放能力之间的耦合。


#### 2.4 缓存代理方案
- 什么叫做缓存代理方案
    - 期望能够在 业务层 和 播放器层 之间搭建一个中间商，由这个新的角色 代理 与业务层的通信，然后 分发 与 执行 播放器层的音视频缓存任务。
- 长远的架构设计考虑
    - 额外定义一个 缓存层 是很有必要的，这意味着容易实现和扩展 更多细节性的需求；比如同时针对多个音视频进行缓存、针对不同优先级缓存任务速度的限制策略等等。



### 02.致敬优秀开源项目
#### 2.1 项目简单介绍
- 网络上比较好的项目：https://github.com/danikula/AndroidVideoCache
    - 网络用的HttpURLConnection，文件缓存处理，文件最大限度策略，回调监听处理，断点续传,代理服务等。
- 但是存在一些问题，比如如下所示
    - 文件的缓存超过限制后没有按照lru算法删除，
    - 处理返回给播放器的http响应头消息，响应头消息的获取处理改为head请求（需服务器支持）
    - 替换网络库为okHttp（因为大部分的项目都是以okHttp为网络请求库的），但是这个改动性比较大


#### 2.2 项目如何使用
- 然后看一下怎么使用，超级简单。传入视频url链接，返回一个代理链接，然后就可以呢
    ``` java
    HttpProxyCacheServer cacheServer = ProxyVideoCacheManager.getProxy(this);
    String proxyUrl = cacheServer.getProxyUrl(URL_AD);
    mVideoPlayer.setUrl(proxyUrl);
  
  
    public static HttpProxyCacheServer getProxy(Context context) {
        return sharedProxy == null ? (sharedProxy = newProxy(context)) : sharedProxy;
    }

    private static HttpProxyCacheServer newProxy(Context context) {
        return new HttpProxyCacheServer.Builder(context)
                .maxCacheSize(512 * 1024 * 1024)       // 512MB for cache
                //缓存路径，不设置默认在sd_card/Android/data/[app_package_name]/cache中
                //.cacheDirectory()
                .build();
    }
    ```



#### 2.3 项目缓存原理
- 大概的原理
    - 原始的方式是直接塞播放地址给播放器，它就可以直接播放。现在我们要在中间加一层本地代理，播放器播放的时候（获取数据）是通过我们的本地代理的地址来播放的，这样我们就可以很好的在中间层（本地代理层）做一些处理，比如：文件缓存，预缓存（秒开处理），监控等。
- 原理详细一点来说
    - 1.采用了本地代理服务的方式，通过原始url给播放器返回一个本地代理的一个url ，代理URL类似：http://127.0.0.1:port/视频url；（port端口为系统随机分配的有效端口，真实url是为了真正的下载），然后播放器播放的时候请求到了你本地的代理上了。
    - 2.本地代理采用ServerSocket监听127.0.0.1的有效端口，这个时候手机就是一个服务器了，客户端就是socket，也就是播放器。
    - 3.读取客户端就是socket来读取数据（http协议请求）解析http协议。
    - 4.根据url检查视频文件是否存在，读取文件数据给播放器，也就是往socket里写入数据（socket通信）。同时如果没有下载完成会进行断点下载,当然弱网的话数据需要生产消费同步处理。


#### 2.4 整体设计思路
- 先说下它的整个设计思路，大体可以理解成两部分，这也是我看完后自己的理解：
    - 1、开启一个线程池去给定的路径下下载文件，将下载的文件保存到本地；
    - 2、视频播放的时候读保存到本地的文件，如果播放的地方还没保存到本地，那就需要等待视频下载到这个地方才能播放；


### 03.原理流程分析
#### 3.1 一些核心类分析
- 构建HttpProxyCacheServer提供给我们可以设置的可以分为三类：
    - 1、设置缓存文件得名字，默认使用的是url的MD5码；
    - 2、设置缓存文件的路径，默认在路径：Android/data/包名/cache；
    - 3、设置缓存文件的大小，默认是512M；




### 04.如何实现预加载
- 其实预加载的思路很简单，在进行一个播放视频后，再返回接下来需要预加载的视频url，启用线程去请求下载数据
    - 开启一个线程去请求并预加载一部分的数据，可能需要预加载的数据大于>1，利用队列先进入的先进行加载，因此可以采用LinkedHashMap保存正在预加载的task。
    - 在开始预加载的时候，判断该播放地址是否已经预加载，如果不是那么创建一个线程task，并且把它放到map集合中。然后执行预加载逻辑，也就是执行HttpURLConnection请求
    - 提供取消对应url加载的任务，因为有可能该url不需要再进行预加载了，比如参考抖音，当用户瞬间下滑几个视频，那么很多视频就需要跳过了不需要再进行预加载



### 06.缓存满了怎么处理


### 14.视频缓冲后拖动问题
- 问题描述
    - 在播放视频的时候，你看到缓冲buffer缓冲到了5分钟，但这个时候你把网络一关闭。然后拖动到3分钟，发现缓冲的视频有时候无法播放，这个是为什么呢？







### 参考博客
- https://blog.csdn.net/ta893115871/article/details/71429738
- https://blog.csdn.net/weixin_34402090/article/details/91367108
- https://blog.csdn.net/u010107153/article/details/107091077
- https://blog.csdn.net/tangedegushi/article/details/80936571

















