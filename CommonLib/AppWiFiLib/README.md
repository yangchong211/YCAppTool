# Wifi功能库组件
#### 目录介绍
- 01.基础概念介绍
- 02.常见思路和做法
- 03.Api调用说明
- 04.遇到的坑分析
- 05.其他问题说明



### 01.基础概念说明
#### 1.1 Wi-Fi相关文档
- Wi-Fi相关文档
    - https://source.android.com/docs/core/connect/wifi-overview?hl=zh-cn
- API相关文档
    - https://developer.android.com/reference/android/net/wifi/WifiManager.html


#### 1.2 WLAN基础功能
- Android Wi-Fi 框架可帮助用户连接到优质 Wi-Fi 网络（在有可用 Wi-Fi 网络且需要连接到这类网络的情况下）。Android 通过两种方式来实现这一功能：
    - 自动开启 Wi-Fi：当用户靠近之前保存的网络时重新开启 Wi-Fi
    - 附近有公共网络时发出通知：当有可用优质开放 Wi-Fi 网络时向用户发出通知
- 自动开启 Wi-Fi
    - 用户可能会出于各种原因停用 Wi-Fi（例如，所连接的网络不稳定），但在回家后可能忘记重新启用 Wi-Fi，从而导致体验不佳。
    - Android 9 中引入的“自动开启 Wi-Fi”功能解决了这一问题：只要设备靠近已保存（即用户过去明确连接过）且 RSSI 足够高的 Wi-Fi 网络，便会自动重新启用 Wi-Fi。
    - 如何设置自动开启Wi-Fi：设置 > 网络和互联网 > Wi-Fi > Wi-Fi 偏好设置 > 自动开启 Wi-Fi
- 附近有公共网络时发出通知。只要出现以下情况，“开放网络通知”功能便会向用户发出通知：
    - WLAN 已启用；设备未连接到 Wi-Fi 网络；有开放且 RSSI 足够高的 Wi-Fi 网络（与内部 Wi-Fi 选择算法使用相同 RSSI 阈值）
    - 启用或停用该功能：设置 > 网络和互联网 > 互联网 > 网络偏好设置 > 附近有公共网络时发出通知


#### 1.3 分配MAC地址行为
- 为什么要随机分配MAC地址
    - 随机分配 MAC 地址功能通过在连接到 WLAN 网络时使用随机分配的 MAC 地址，可以加强用户隐私保护。
    - 设备在连接到 WLAN 网络或接入点时会使用 MAC 地址。由于这些 MAC 地址未经加密即被传输，因此可能会被捕获并用于跟踪用户的位置。
    - 过去，设备使用出厂 MAC 地址连接到 WLAN 网络。出厂 MAC 地址在全球范围内是唯一的静态地址，可以跟踪和逐个识别设备。
- 随机分配 MAC 地址类型
    - Android 框架使用两种类型的随机分配 MAC 地址功能：永久性随机分配和非永久性随机分配。
    - 如果用户停用随机分配 MAC 地址功能，则系统会使用出厂 MAC 地址。



### 02.常见思路和做法
#### 2.1 连接Wi-Fi方式
- 连接Wi-Fi目前可能的方式
    - 给定WiFi名称，连接无密码的网络
    - 给定WiFi名称 和密码，连接网络 （需指定密码类型 wpa 或者web ）
- WEB 和 WPA 有何区别？
    - WEP 代表有线等效隐私。它是世界上普遍使用的Wi-Fi安全协议。WEP 旨在支持类似于有线网络的保护级别。用户可以将他们的连接点设置为打开或使用共享密钥。将其设置为 open 允许任何链接到网络的人，而共享密钥使用密码来验证用户是否已获得认证。
    - WPA是继承了WEP基本原理而又解决了WEP缺点的一种新技术。由于加强了生成加密密钥的算法，因此即便收集到分组信息并对其进行解析，也几乎无法计算出通用密钥。



#### 2.2 连接Wi-Fi步骤
- 第一步：判断并开启Wi-Fi
    - 判断当前手机wifi网络是否开启可用。如果不可用，则需要首先打开Wi-Fi开关。
    - 打开关闭wifi使用wifiManager.setWifiEnabled()的方法，打开关闭前，先要判断wifi的状态，使用isWifiEnabled()方法。
- 第二步：根据Wi-Fi名称获取/创建WifiConfiguration
    - 连接已经配置过wifi，首先检查是否已经配置过该wifi，通过WifiManager获取已经配置的wifi列表。传入要连接的wifi的SSID。
    - 对于连接已经配置过的wifi，这里遍历的结果返回一个WifiConfiguration的对象，拿来实现连接。
- 第三步：将网络配置添加到管理器中
    - 将wifiConfig配置添加到wifiManager管理器中。
- 第四步：判断是否连接上Wi-Fi
    - 判断是否连接到Wi-Fi的状态。判断是否保持配置，是否连接上网络等条件。



#### 2.3 开启Wi-Fi操作
- 开启WiFi一般需要一定的时间，因此不能立马去连接，需要等WiFi稳定可用，经测试一般2.5秒即可完成



### 03.Api调用说明



### 04.遇到的坑分析
#### 4.1 Wi-Fi减少耗电量
- 背景说明
    - Wi-Fi 首选分流网络 (PNO) 扫描是在设备与 Wi-Fi 断开连接且屏幕关闭后定期发生的低电耗 Wi-Fi 扫描。PNO 扫描用于查找并连接到已保存的网络。
    - 在搭载 Android 9 或更低版本的设备上，当设备与 Wi-Fi 断开连接且屏幕关闭后，PNO 扫描将以 20 秒为间隔执行前三次扫描，并以 60 秒为间隔执行所有后续扫描。找到已保存的网络或屏幕开启时，PNO 扫描会停止。
- 如何减少耗电量
    - Android 10 在 WifiManager 中引入了一个名为 setDeviceMobilityState() 的可选 API 方法，该方法可根据设备的移动状态增加 PNO 扫描的间隔时长，从而减少耗电量。
    - 如果设备处于静止状态，Android 框架会将 PNO 扫描的间隔时长从 60 秒增加到 180 秒，以减少耗电量。这种优化基于以下假设：在设备没有移动时，设备不可能通过 PNO 扫描找到任何新网络。






### 05.其他问题说明

- https://blog.51cto.com/u_15117645/6161918


